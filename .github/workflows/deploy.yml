name: Deploy POS System

on:
   push:
      branches: [main, demo]
      paths:
         - 'client/**'
         - 'server/**'
         - '.github/workflows/**'

concurrency:
   group: ${{ github.workflow }}-${{ github.ref }}
   cancel-in-progress: true

env:
   REGION: us-central1
   ARTIFACT_REPO: smart-pos-repo
   SERVER_SERVICE_NAME: server
   CLIENT_SERVICE_NAME: client

jobs:
   build-and-deploy:
      runs-on: ubuntu-latest
      steps:
         - name: Checkout Code
           uses: actions/checkout@v4

         - name: Configure Environment Context
           run: |
              if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
                echo "ENV_NAME=PROD" >> $GITHUB_ENV
                echo "GCP_PROJECT_ID=${{ secrets.PROD_GCP_PROJECT_ID }}" >> $GITHUB_ENV
                echo "RUNNER_SA=app-runner@audiovideo-pos.iam.gserviceaccount.com" >> $GITHUB_ENV
                
                echo "SUPABASE_URL_VAL=${{ secrets.PROD_VITE_SUPABASE_URL }}" >> $GITHUB_ENV
                echo "SUPABASE_KEY_VAL=${{ secrets.PROD_VITE_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV

              elif [[ $GITHUB_REF == 'refs/heads/demo' ]]; then
                echo "ENV_NAME=DEMO" >> $GITHUB_ENV
                echo "GCP_PROJECT_ID=${{ secrets.DEV_GCP_PROJECT_ID }}" >> $GITHUB_ENV
                echo "RUNNER_SA=app-runner@smartpos-1.iam.gserviceaccount.com" >> $GITHUB_ENV
                
                echo "SUPABASE_URL_VAL=${{ secrets.DEV_VITE_SUPABASE_URL }}" >> $GITHUB_ENV
                echo "SUPABASE_KEY_VAL=${{ secrets.DEV_VITE_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
              fi

         - name: Set Artifact Registry Host
           run: echo "REGISTRY_HOST=${{ env.REGION }}-docker.pkg.dev" >> $GITHUB_ENV

         - name: Authenticate to Google Cloud (PROD)
           if: env.ENV_NAME == 'PROD'
           uses: google-github-actions/auth@v2
           with:
              credentials_json: ${{ secrets.PROD_GCP_SA_KEY }}

         - name: Authenticate to Google Cloud (DEMO)
           if: env.ENV_NAME == 'DEMO'
           uses: google-github-actions/auth@v2
           with:
              credentials_json: ${{ secrets.DEV_GCP_SA_KEY }}

         - name: Set up Cloud SDK
           uses: google-github-actions/setup-gcloud@v2

         - name: Configure Docker Auth
           run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         # ------------------------------------------------------------------
         # SERVER DEPLOYMENT
         # ------------------------------------------------------------------

         - name: Build and Push Server
           uses: docker/build-push-action@v5
           with:
              context: ./server
              push: true
              tags: |
                 ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/server:latest
                 ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/server:${{ github.sha }}
              cache-from: type=gha,scope=server-${{ env.ENV_NAME }}
              cache-to: type=gha,mode=max,scope=server-${{ env.ENV_NAME }}

         - name: Deploy Server to Cloud Run
           run: |
              gcloud run deploy ${{ env.SERVER_SERVICE_NAME }} \
                --image ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/server:${{ github.sha }} \
                --project ${{ env.GCP_PROJECT_ID }} \
                --region ${{ env.REGION }} \
                --platform managed \
                --allow-unauthenticated \
                --service-account ${{ env.RUNNER_SA }} \
                --set-env-vars NODE_ENV=production \
                --set-secrets="SUPABASE_URL=SUPABASE_URL:latest,SUPABASE_KEY=SUPABASE_KEY:latest,SUPABASE_JWT_SECRET=SUPABASE_JWT_SECRET:latest" \
                --quiet

         # ------------------------------------------------------------------
         # CLIENT DEPLOYMENT
         # ------------------------------------------------------------------

         - name: Determine API URL
           id: get-url
           run: |
              if [ -n "${{ env.FIXED_API_URL }}" ]; then
                 echo "DETECTED_API_URL=${{ env.FIXED_API_URL }}" >> $GITHUB_ENV
              else
                 DETECTED_URL=$(gcloud run services describe ${{ env.SERVER_SERVICE_NAME }} \
                   --project ${{ env.GCP_PROJECT_ID }} \
                   --region ${{ env.REGION }} \
                   --format 'value(status.url)')
                 echo "DETECTED_API_URL=$DETECTED_URL" >> $GITHUB_ENV
              fi

         - name: Build and Push Client
           uses: docker/build-push-action@v5
           with:
              context: ./client
              push: true
              build-args: |
                 VITE_API_URL=${{ env.DETECTED_API_URL }}
              tags: |
                 ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/client:latest
                 ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/client:${{ github.sha }}
              cache-from: type=gha,scope=client-${{ env.ENV_NAME }}
              cache-to: type=gha,mode=max,scope=client-${{ env.ENV_NAME }}

         - name: Deploy Client to Cloud Run
           run: |
              gcloud run deploy ${{ env.CLIENT_SERVICE_NAME }} \
                --image ${{ env.REGISTRY_HOST }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/client:${{ github.sha }} \
                --project ${{ env.GCP_PROJECT_ID }} \
                --region ${{ env.REGION }} \
                --platform managed \
                --allow-unauthenticated \
                --service-account ${{ env.RUNNER_SA }} \
                --quiet
